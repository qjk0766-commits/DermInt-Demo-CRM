<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DermInt CRM | Демо-панель</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        medical: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            900: '#134e4a',
                        }
                    },
                    spacing: {
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom Utilities */
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .pin-input {
            letter-spacing: 0.5em;
            text-align: center;
            font-size: 1.5rem;
            -webkit-text-security: disc;
        }

        /* Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Search Dropdown Animation */
        .search-dropdown {
            transform-origin: top;
            transition: all 0.2s ease-out;
        }
        .search-dropdown.hidden {
            opacity: 0;
            transform: scaleY(0.95);
            pointer-events: none;
        }
        .search-dropdown.visible {
            opacity: 1;
            transform: scaleY(1);
            pointer-events: auto;
        }
        
        /* Mobile Specifics */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-gray-800 antialiased h-screen flex overflow-hidden pb-16 lg:pb-0">

    <!-- MOBILE OVERLAY -->
    <div id="mobile-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="bg-white border-r border-gray-200 w-72 fixed inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-200 ease-in-out z-50 flex flex-col h-full shadow-xl lg:shadow-none">
        <!-- Logo -->
        <div class="h-16 flex items-center px-6 border-b border-gray-100 justify-between lg:justify-start">
            <div class="flex items-center">
                <div class="bg-medical-600 text-white p-1.5 rounded mr-3">
                    <i class="fa-solid fa-staff-snake text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-900 leading-none text-lg">DermInt</h1>
                    <span class="text-xs text-medical-600 font-medium">Medical CRM</span>
                </div>
            </div>
            <!-- Close button for mobile -->
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-500 p-2">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <!-- Nav -->
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1 px-3" id="sidebar-menu">
                <li><button onclick="navigateTo('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-3 py-3 rounded-lg text-sm font-medium flex items-center transition-colors"><i class="fa-solid fa-chart-pie w-6 text-lg"></i> Дашборд</button></li>
                <li><button onclick="navigateTo('patients')" id="nav-patients" class="nav-item w-full text-left px-3 py-3 rounded-lg text-sm font-medium flex items-center transition-colors"><i class="fa-solid fa-users w-6 text-lg"></i> Пацієнти</button></li>
                <li><button onclick="navigateTo('calendar')" id="nav-calendar" class="nav-item w-full text-left px-3 py-3 rounded-lg text-sm font-medium flex items-center transition-colors"><i class="fa-regular fa-calendar-check w-6 text-lg"></i> Запис / Календар</button></li>
                <li><button onclick="navigateTo('finances_global')" id="nav-finances_global" class="nav-item w-full text-left px-3 py-3 rounded-lg text-sm font-medium flex items-center transition-colors"><i class="fa-solid fa-file-invoice-dollar w-6 text-lg"></i> Фінанси</button></li>
                <li><button onclick="navigateTo('docs_global')" id="nav-docs_global" class="nav-item w-full text-left px-3 py-3 rounded-lg text-sm font-medium flex items-center transition-colors"><i class="fa-solid fa-folder-open w-6 text-lg"></i> Документи</button></li>
                <li><button onclick="navigateTo('drafts_global')" id="nav-drafts_global" class="nav-item w-full text-left px-3 py-3 rounded-lg text-sm font-medium flex items-center transition-colors"><i class="fa-solid fa-user-doctor w-6 text-lg"></i> Чернетки <i class="fa-solid fa-lock text-xs ml-auto text-gray-400"></i></button></li>
            </ul>
        </nav>

        <!-- Doctor Profile Mini -->
        <div class="border-t border-gray-200 p-4 bg-gray-50 lg:bg-white pb-safe lg:pb-4">
            <div class="flex items-center">
                <img src="https://ui-avatars.com/api/?name=Mykhailo+Ternuschak&background=0d9488&color=fff" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                <div class="ml-3">
                    <p class="text-sm font-semibold text-gray-900">Михайло Тернущак</p>
                    <p class="text-xs text-gray-500">Головний лікар</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 lg:hidden z-30 flex justify-around items-center h-16 pb-safe shadow-lg">
        <button onclick="navigateTo('dashboard')" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-medical-600 active:text-medical-600">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Дашборд</span>
        </button>
        <button onclick="navigateTo('patients')" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-medical-600 active:text-medical-600 text-medical-600">
            <i class="fa-solid fa-users text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Пацієнти</span>
        </button>
        <button onclick="navigateTo('calendar')" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-medical-600 active:text-medical-600">
            <i class="fa-regular fa-calendar-check text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Календар</span>
        </button>
        <button onclick="toggleSidebar()" class="flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-medical-600 active:text-medical-600">
            <i class="fa-solid fa-bars text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Меню</span>
        </button>
    </nav>

    <!-- MOBILE FAB (Floating Action Button) -->
    <button onclick="openModal('appointment')" class="lg:hidden fixed bottom-20 right-4 bg-medical-600 text-white w-14 h-14 rounded-full shadow-xl z-30 flex items-center justify-center text-2xl hover:bg-medical-700 transition-transform active:scale-90 ring-2 ring-white">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative w-full">
        
        <!-- TOP BAR -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-8 z-10 shadow-sm relative">
            
            <!-- Mobile Logo / Title -->
            <div class="flex items-center lg:hidden">
                 <h1 class="font-bold text-gray-900 text-lg">DermInt</h1>
            </div>

            <!-- Mobile Search Toggle -->
             <button onclick="toggleMobileSearch()" class="lg:hidden p-2 text-gray-500">
                <i class="fa-solid fa-magnifying-glass text-lg"></i>
            </button>

            <!-- Desktop Search with Dropdown -->
            <div class="flex-1 max-w-xl mx-auto hidden lg:block relative group">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </span>
                <input type="text" 
                    id="global-search"
                    placeholder="Пошук пацієнта..." 
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-medical-500 focus:border-transparent transition-shadow"
                    onfocus="toggleSearchHelp(true)"
                    onblur="setTimeout(() => toggleSearchHelp(false), 200)">
                
                <!-- Search Tooltip Dropdown -->
                <div id="search-help" class="search-dropdown hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-200 p-4 z-50 text-sm">
                    <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-gears text-medical-500"></i> Розширений фільтр (в розробці)
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <span class="text-xs font-bold text-gray-400 uppercase">Основний пошук</span>
                            <p class="text-gray-600">По Прізвищу, Імені, По-Батькові, номеру телефону.</p>
                        </div>
                        <div class="border-t border-gray-100 pt-2">
                            <span class="text-xs font-bold text-gray-400 uppercase">Фільтри</span>
                            <ul class="grid grid-cols-2 gap-2 mt-1 text-gray-600">
                                <li class="flex items-center gap-2"><i class="fa-regular fa-calendar text-gray-400"></i> Дата народження (Від-До)</li>
                                <li class="flex items-center gap-2"><i class="fa-solid fa-stethoscope text-gray-400"></i> Діагноз (МКХ-10)</li>
                                <li class="flex items-center gap-2"><i class="fa-solid fa-tags text-gray-400"></i> Категорія послуг</li>
                                <li class="flex items-center gap-2"><i class="fa-solid fa-arrow-up-9-1 text-gray-400"></i> К-сть відвідувань</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center space-x-3 ml-4">
                <!-- Quick Actions (Hidden on Mobile, replaced by FAB) -->
                <div class="hidden lg:flex items-center space-x-2 mr-4 border-r border-gray-200 pr-4">
                    <button onclick="openModal('appointment')" class="p-2 text-gray-500 hover:text-medical-600 hover:bg-medical-50 rounded-full transition-colors" title="Новий запис">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button onclick="showToast('Функція друку недоступна в демо', 'info')" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full" title="Друк">
                        <i class="fa-solid fa-print"></i>
                    </button>
                </div>

                <!-- Mode Toggle -->
                <div class="hidden md:flex items-center bg-gray-100 rounded-lg p-1">
                    <button onclick="setMode('view')" id="btn-mode-view" class="px-3 py-1.5 rounded-md text-xs font-semibold shadow-sm bg-white text-gray-800 transition-all">
                        <i class="fa-regular fa-eye mr-1"></i> Перегляд
                    </button>
                    <button onclick="setMode('edit')" id="btn-mode-edit" class="px-3 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-900 transition-all">
                        <i class="fa-solid fa-pen mr-1"></i> Редагування
                    </button>
                </div>
                <!-- Mobile Edit Mode Icon -->
                <button onclick="toggleMobileMode()" class="md:hidden p-2 text-gray-500">
                     <i id="mobile-mode-icon" class="fa-solid fa-pen-to-square text-lg"></i>
                </button>
            </div>
            
            <!-- Mobile Search Overlay -->
            <div id="mobile-search-bar" class="absolute top-16 left-0 right-0 bg-white p-4 shadow-lg border-b border-gray-200 hidden lg:hidden animate-fade">
                <input type="text" placeholder="Пошук пацієнта..." class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-medical-500">
            </div>
        </header>

        <!-- DYNAMIC CONTENT CONTAINER -->
        <div id="app-content" class="flex-1 overflow-y-auto bg-gray-50 p-4 lg:p-8">
            <!-- Content injected by JS -->
        </div>

    </main>

    <!-- MODAL CONTAINER -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl max-w-lg w-full transform scale-95 transition-transform duration-200">
            <!-- Dynamic Modal Content -->
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container" class="fixed bottom-20 lg:bottom-5 right-5 z-[70] flex flex-col space-y-2"></div>

    <!-- JAVASCRIPT APP LOGIC -->
    <script>
        // --- STATE & DATA ---
        const state = {
            currentView: 'patients', // 'dashboard', 'patients', 'calendar', 'finances_global', 'docs_global', 'drafts_global'
            mode: 'view', // 'view' or 'edit'
            pinLocked: true,
            pin: '1234',
            inactivityTimer: null,
            activeTab: 'medical' // 'profile', 'medical', 'visits', 'finance', 'docs', 'drafts', 'photos'
        };

        const demoPatient = {
            id: "UA-2023-884",
            info: {
                firstName: "Олена",
                middleName: "Петрівна",
                lastName: "Коваленко",
                dob: "1988-04-12",
                gender: "female",
                phone: "+380 50 123 45 67",
                email: "o.kovalenko88@gmail.com",
                city: "Київ",
                address: "вул. Хрещатик, 24, кв. 12",
                avatar: "https://ui-avatars.com/api/?name=Олена+Коваленко&background=fce7f3&color=db2777&size=128",
                tags: ["VIP", "Дерматологія", "Трихологія"],
                notes: "Надає перевагу запису у вечірній час."
            },
            medical: {
                allergies: ["Пеніцилін", "Лідокаїн (сумнівно)"],
                chronic: ["Гастрит"],
                complaints: "Випадіння волосся, сухість шкіри голови, періодичні висипання на обличчі.",
                diagnosis: [
                    { date: "2023-10-01", code: "L21.0", name: "Себорея голови" },
                    { date: "2023-11-15", code: "L64.9", name: "Андрогенетична алопеція I ст." }
                ],
                labResults: [
                    { date: "2023-11-10", name: "Загальний аналіз крові", status: "norm", val: "Норма" },
                    { date: "2023-11-10", name: "Феритин", status: "low", val: "12 нг/мл (Норма: 15-150)" },
                    { date: "2023-11-10", name: "ТТГ", status: "norm", val: "2.1 мМО/л" }
                ]
            },
            photos: [
                { id: 1, date: "2023-10-01", tag: "Трихоскопія", src: "https://placehold.co/300x300/e2e8f0/1e293b?text=Dermatoscopy+v1", note: "Потилична зона, до лікування" },
                { id: 2, date: "2023-10-01", tag: "Клінічне фото", src: "https://placehold.co/300x300/fecaca/991b1b?text=Scalp+Redness", note: "Виражене почервоніння" },
                { id: 3, date: "2023-11-15", tag: "Трихоскопія", src: "https://placehold.co/300x300/ccfbf1/0f766e?text=Dermatoscopy+v2", note: "Контроль. Зменшення запалення" },
                { id: 4, date: "2023-11-15", tag: "Макро", src: "https://placehold.co/300x300/ffedd5/9a3412?text=Macro+Lens", note: "Зона росту" }
            ],
            plan: {
                active: true,
                steps: [
                    { id: 1, text: "Корекція дефіциту заліза", status: "done" },
                    { id: 2, text: "Курс мезотерапії (10 процедур)", status: "in-progress", progress: "4/10" },
                    { id: 3, text: "Плазмотерапія (PRP)", status: "pending" },
                    { id: 4, text: "Підбір домашнього догляду", status: "done" }
                ],
                meds: "Сорбіфер Дурулес 1т/2р.д., Вітамін D3 2000 MO."
            },
            visits: [
                { id: 101, date: "2023-10-01 10:00", type: "Первинна консультація", doctor: "Др. Тернущак", price: 800, status: "completed", note: "Збір анамнезу, трихоскопія." },
                { id: 102, date: "2023-10-15 11:30", type: "Мезотерапія шкіри голови", doctor: "Др. Тернущак", price: 1500, status: "completed", note: "Процедура #1. Перенесла добре." },
                { id: 103, date: "2023-10-29 11:30", type: "Мезотерапія шкіри голови", doctor: "Др. Тернущак", price: 1500, status: "completed", note: "Процедура #2." },
                { id: 104, date: "2023-11-12 11:30", type: "Мезотерапія шкіри голови", doctor: "Др. Тернущак", price: 1500, status: "completed", note: "Процедура #3." },
                { id: 105, date: "2023-11-26 11:30", type: "Мезотерапія шкіри голови", doctor: "Др. Тернущак", price: 1500, status: "completed", note: "Процедура #4." },
                { id: 106, date: "2023-12-10 11:30", type: "Консультація + Огляд", doctor: "Др. Тернущак", price: 600, status: "no-show", note: "Не з'явилась, не попередила." },
                { id: 107, date: "2023-12-28 15:00", type: "Мезотерапія шкіри голови", doctor: "Др. Тернущак", price: 1500, status: "scheduled", note: "" },
                { id: 108, date: "2024-01-11 15:00", type: "Плазмотерапія", doctor: "Др. Тернущак", price: 2500, status: "scheduled", note: "" }
            ],
            payments: [
                { id: "INV-001", date: "2023-10-01", service: "Консультація", amount: 800, method: "card", status: "paid" },
                { id: "INV-002", date: "2023-10-15", service: "Мезотерапія", amount: 1500, method: "cash", status: "paid" },
                { id: "INV-003", date: "2023-10-29", service: "Мезотерапія", amount: 1500, method: "card", status: "paid" },
                { id: "INV-004", date: "2023-11-12", service: "Мезотерапія", amount: 1500, method: "transfer", status: "paid" },
                { id: "INV-005", date: "2023-11-26", service: "Мезотерапія", amount: 1500, method: "card", status: "partially-paid", paid: 1000, due: 500 },
                { id: "INV-006", date: "2023-12-10", service: "Штраф (неявка)", amount: 300, method: "-", status: "unpaid" }
            ],
            docs: [
                { name: "Інформована згода (Мезотерапія)", date: "2023-10-15", type: "pdf", size: "1.2 MB" },
                { name: "Результати аналізів (Діла)", date: "2023-11-10", type: "pdf", size: "0.8 MB" },
                { name: "Фототрихограма (до)", date: "2023-10-01", type: "img", size: "3.5 MB" },
                { name: "План лікування v1", date: "2023-10-01", type: "doc", size: "0.5 MB" }
            ],
            drafts: [
                { id: 1, date: "2023-12-20", title: "Нотатка про реакцію", content: "Пацієнтка скаржилась на свербіж після останнього препарату. Розглянути зміну коктейлю на наступний раз." },
                { id: 2, date: "2023-11-05", title: "Особисте", content: "Чоловік теж хоче записатися на огляд родимок. Нагадати їй." },
                { id: 3, date: "2023-10-01", title: "Думки по діагнозу", content: "Схоже на поєднання АГА та телогенового випадіння. Потрібно виключити дефіцити." }
            ]
        };

        const financeStats = {
            totalPaid: 6300,
            totalDue: 800,
            avgCheck: 1260,
            lastPay: "2023-11-26"
        };

        // --- UTILS ---
        const formatCurrency = (val) => new Intl.NumberFormat('uk-UA', { style: 'currency', currency: 'UAH', minimumFractionDigits: 0 }).format(val);
        const el = (id) => document.getElementById(id);
        
        // --- RENDERERS ---

        function renderApp() {
            const container = el('app-content');
            
            // Logic to render different views based on sidebar selection
            switch(state.currentView) {
                case 'dashboard':
                    container.innerHTML = getDashboardHTML();
                    initChart();
                    break;
                case 'patients':
                    container.innerHTML = getPatientProfileHTML();
                    break;
                case 'calendar':
                    container.innerHTML = getGlobalCalendarHTML();
                    break;
                case 'finances_global':
                    container.innerHTML = getGlobalFinancesHTML();
                    break;
                case 'docs_global':
                    container.innerHTML = getGlobalDocsHTML();
                    break;
                case 'drafts_global':
                    container.innerHTML = getGlobalDraftsHTML();
                    break;
                default:
                    container.innerHTML = getPatientProfileHTML();
            }
            
            updateModeUI();
            updateSidebarActiveState();
        }

        function updateSidebarActiveState() {
            // Remove active classes from all nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('bg-medical-50', 'text-medical-700');
                item.classList.add('text-gray-600');
            });

            // Add active class to current view
            const activeId = `nav-${state.currentView}`;
            const activeEl = el(activeId);
            if(activeEl) {
                activeEl.classList.remove('text-gray-600');
                activeEl.classList.add('bg-medical-50', 'text-medical-700');
            }
        }

        function getDashboardHTML() {
            return `
                <div class="fade-in max-w-6xl mx-auto">
                    <h2 class="text-xl lg:text-2xl font-bold mb-4 lg:mb-6 text-gray-800">Дашборд: DermInt</h2>
                    
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-xs lg:text-sm font-medium mb-1">Візитів (тижд)</div>
                            <div class="text-2xl lg:text-3xl font-bold text-gray-900">24</div>
                            <div class="text-green-500 text-[10px] lg:text-xs mt-1"><i class="fa-solid fa-arrow-up"></i> +12%</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-xs lg:text-sm font-medium mb-1">Виручка (тижд)</div>
                            <div class="text-2xl lg:text-3xl font-bold text-gray-900">32k</div>
                            <div class="text-green-500 text-[10px] lg:text-xs mt-1"><i class="fa-solid fa-arrow-up"></i> +5%</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-xs lg:text-sm font-medium mb-1">Сер. чек</div>
                            <div class="text-2xl lg:text-3xl font-bold text-gray-900">1.3k</div>
                            <div class="text-gray-400 text-[10px] lg:text-xs mt-1">Без змін</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-xs lg:text-sm font-medium mb-1">Неявки</div>
                            <div class="text-2xl lg:text-3xl font-bold text-red-500">2</div>
                            <div class="text-red-400 text-[10px] lg:text-xs mt-1">Увага</div>
                        </div>
                    </div>

                    <!-- Chart & Table -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-4 lg:p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 mb-4 text-sm lg:text-base">Динаміка доходу (8 тижнів)</h3>
                            <div class="h-48 lg:h-64 relative w-full">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-4 lg:p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 mb-4 text-sm lg:text-base">Топ послуг</h3>
                            <ul class="space-y-4">
                                <li class="flex justify-between items-center">
                                    <span class="text-xs lg:text-sm text-gray-600">Консультація</span>
                                    <span class="text-xs lg:text-sm font-bold bg-blue-50 text-blue-700 px-2 py-1 rounded">42%</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span class="text-xs lg:text-sm text-gray-600">Мезотерапія</span>
                                    <span class="text-xs lg:text-sm font-bold bg-teal-50 text-teal-700 px-2 py-1 rounded">28%</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span class="text-xs lg:text-sm text-gray-600">Видалення</span>
                                    <span class="text-xs lg:text-sm font-bold bg-purple-50 text-purple-700 px-2 py-1 rounded">15%</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- NEW GLOBAL VIEWS MOCKUPS ---
        function getGlobalCalendarHTML() {
            return `
                <div class="fade-in max-w-6xl mx-auto h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-800">Календар</h2>
                        <div class="flex gap-2">
                             <button class="px-3 py-1 bg-white border rounded text-xs lg:text-sm">Сьогодні</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex-1 flex items-center justify-center bg-gray-50 border-dashed">
                        <div class="text-center">
                            <i class="fa-regular fa-calendar-days text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 font-medium">Тут відображається розклад на тиждень/місяць</p>
                            <p class="text-xs text-gray-400 mt-2">(Демонстраційна сторінка)</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getGlobalFinancesHTML() {
            return `
                <div class="fade-in max-w-6xl mx-auto">
                    <h2 class="text-xl lg:text-2xl font-bold mb-6 text-gray-800">Фінанси та Каса</h2>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b flex gap-4 overflow-x-auto">
                            <button class="text-medical-600 font-bold border-b-2 border-medical-600 pb-1 whitespace-nowrap">Транзакції</button>
                            <button class="text-gray-500 hover:text-gray-700 pb-1">Звіти</button>
                            <button class="text-gray-500 hover:text-gray-700 pb-1">Зарплати</button>
                        </div>
                        
                        <!-- Desktop Table -->
                        <table class="w-full text-sm text-left hidden lg:table">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">Дата</th>
                                    <th class="p-4">Пацієнт</th>
                                    <th class="p-4">Послуга</th>
                                    <th class="p-4 text-right">Сума</th>
                                    <th class="p-4 text-center">Статус</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr>
                                    <td class="p-4">Сьогодні, 10:00</td>
                                    <td class="p-4 font-medium">Коваленко О.П.</td>
                                    <td class="p-4">Консультація</td>
                                    <td class="p-4 text-right font-mono">800 ₴</td>
                                    <td class="p-4 text-center"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">Сплачено</span></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Mobile Cards -->
                        <div class="lg:hidden p-4 space-y-3">
                             <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <div class="flex justify-between mb-1">
                                    <span class="font-bold text-gray-900">Коваленко О.П.</span>
                                    <span class="font-bold text-green-600">800 ₴</span>
                                </div>
                                <div class="text-xs text-gray-500 mb-2">Консультація • 10:00</div>
                                <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] uppercase font-bold">Сплачено</span>
                             </div>
                        </div>

                    </div>
                </div>
            `;
        }

        function getGlobalDocsHTML() {
             return `
                <div class="fade-in max-w-6xl mx-auto">
                    <h2 class="text-xl lg:text-2xl font-bold mb-6 text-gray-800">Реєстр документів</h2>
                     <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 text-center">
                         <i class="fa-solid fa-folder-tree text-5xl text-gray-300 mb-4"></i>
                         <p class="text-gray-500">Загальний архів документів клініки</p>
                     </div>
                </div>
            `;
        }

        function getGlobalDraftsHTML() {
             return getDraftsLockScreen(true);
        }

        function getDraftsLockScreen(isGlobal = false) {
             if (state.pinLocked) {
                    return `
                        <div class="flex flex-col items-center justify-center h-full min-h-[500px] bg-gray-100 rounded-xl border border-gray-200 fade-in m-4">
                            <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-sm w-full">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                                    <i class="fa-solid fa-lock text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2">Захищений розділ ${isGlobal ? '(Глобальний)' : ''}</h3>
                                <p class="text-sm text-gray-500 mb-6">Введіть PIN лікаря для доступу.</p>
                                
                                <input type="password" id="pin-input" maxlength="4" class="pin-input w-full border border-gray-300 rounded-lg py-3 mb-4 focus:ring-2 focus:ring-medical-500 focus:border-medical-500 outline-none" placeholder="••••">
                                
                                <button onclick="unlockDrafts()" class="w-full bg-medical-600 text-white font-bold py-3 rounded-lg hover:bg-medical-700 transition-colors">Відкрити</button>
                                <p class="text-xs text-gray-400 mt-4">Код за замовчуванням: 1234</p>
                            </div>
                        </div>
                    `;
             } else {
                 // Unlocked content Mock
                 return `
                    <div class="fade-in max-w-4xl mx-auto p-4 lg:p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl lg:text-2xl font-bold text-gray-800">Мої нотатки</h2>
                            <button onclick="lockDrafts()" class="text-red-500 text-sm hover:underline"><i class="fa-solid fa-lock"></i> Заблокувати</button>
                        </div>
                        <div class="grid gap-4">
                             ${demoPatient.drafts.map(d => `
                                <div class="bg-yellow-50 p-5 rounded-xl border border-yellow-200 shadow-sm">
                                    <span class="text-xs font-bold text-yellow-800 uppercase block mb-1">${d.date} | ${demoPatient.info.lastName}</span>
                                    <h4 class="font-bold text-gray-800 mb-1">${d.title}</h4>
                                    <p class="text-sm text-gray-700">${d.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                 `;
             }
        }

        // --- PATIENT PROFILE ---
        function getPatientProfileHTML() {
            const p = demoPatient;
            const isEdit = state.mode === 'edit';
            
            // Generate Tabs
            const tabs = [
                {id: 'medical', icon: 'fa-heart-pulse', label: 'Картка'},
                {id: 'photos', icon: 'fa-camera', label: 'Фото'},
                {id: 'plan', icon: 'fa-list-check', label: 'План'},
                {id: 'visits', icon: 'fa-calendar', label: 'Візити'},
                {id: 'finance', icon: 'fa-hryvnia-sign', label: 'Каса'},
                {id: 'docs', icon: 'fa-file', label: 'Доки'},
                {id: 'drafts', icon: 'fa-lock', label: 'Drafts', protected: true}
            ];

            const tabsHTML = tabs.map(t => `
                <button onclick="setActiveTab('${t.id}')" 
                    class="pb-3 px-4 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 whitespace-nowrap
                    ${state.activeTab === t.id ? 'border-medical-600 text-medical-700' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                    <i class="fa-solid ${t.icon}"></i> ${t.label}
                </button>
            `).join('');

            // Generate Content based on Active Tab
            let contentHTML = '';
            
            if (state.activeTab === 'medical') {
                contentHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade">
                        <!-- Left: Diagnoses & Allergies -->
                        <div class="space-y-4 lg:space-y-6">
                            <div class="bg-white p-4 lg:p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fa-solid fa-notes-medical text-medical-500"></i> Діагнози</h4>
                                <ul class="space-y-2 mb-4">
                                    ${p.medical.diagnosis.map(d => `
                                        <li class="bg-red-50 text-red-700 px-3 py-2 rounded-lg text-sm border border-red-100">
                                            <span class="font-bold block text-xs opacity-75">${d.code} · ${d.date}</span>
                                            ${d.name}
                                        </li>
                                    `).join('')}
                                </ul>
                                ${isEdit ? '<button class="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-400 hover:border-medical-500 hover:text-medical-500 text-sm font-medium transition-colors">+ Додати діагноз</button>' : ''}
                            </div>

                            <div class="bg-white p-4 lg:p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h4 class="font-bold text-gray-800 mb-3">Особливості</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase font-bold">Алергії</label>
                                        ${isEdit ? 
                                            `<input class="w-full mt-1 p-2 border rounded text-sm bg-gray-50" value="${p.medical.allergies.join(', ')}">` : 
                                            `<div class="text-red-600 font-medium text-sm mt-1 bg-red-50 p-2 rounded">${p.medical.allergies.join(', ')}</div>`
                                        }
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 uppercase font-bold">Хронічні</label>
                                        <div class="text-gray-700 text-sm mt-1">${p.medical.chronic.join(', ')}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Anamnesis & Labs -->
                        <div class="lg:col-span-2 space-y-4 lg:space-y-6">
                            <div class="bg-white p-4 lg:p-6 rounded-xl border border-gray-200 shadow-sm">
                                <h4 class="font-bold text-gray-800 mb-3">Анамнез та скарги</h4>
                                ${isEdit ? 
                                    `<textarea class="w-full h-32 p-3 border rounded-lg text-sm focus:ring-2 focus:ring-medical-500 outline-none">${p.medical.complaints}</textarea>` :
                                    `<p class="text-gray-600 text-sm leading-relaxed whitespace-pre-line">${p.medical.complaints}</p>`
                                }
                            </div>

                            <div class="bg-white p-4 lg:p-6 rounded-xl border border-gray-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold text-gray-800">Останні аналізи</h4>
                                    <span class="text-xs text-gray-400">Синєво / Діла API</span>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs text-gray-500 bg-gray-50 uppercase">
                                            <tr><th class="px-3 py-2">Дата</th><th class="px-3 py-2">Показник</th><th class="px-3 py-2">Результат</th></tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            ${p.medical.labResults.map(l => `
                                                <tr>
                                                    <td class="px-3 py-3 text-gray-500 whitespace-nowrap">${l.date}</td>
                                                    <td class="px-3 py-3 font-medium text-gray-900">${l.name}</td>
                                                    <td class="px-3 py-3">
                                                        <span class="px-2 py-1 rounded text-xs font-bold ${l.status === 'low' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">
                                                            ${l.val}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.activeTab === 'photos') {
                contentHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-800">Фотодокументація</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${p.photos.map(ph => `
                                <div class="group relative rounded-lg overflow-hidden border border-gray-200 shadow-sm bg-white">
                                    <img src="${ph.src}" alt="${ph.tag}" class="w-full h-32 lg:h-40 object-cover group-hover:scale-105 transition-transform duration-300">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3">
                                        <p class="text-white text-xs font-bold">${ph.tag}</p>
                                        <p class="text-gray-300 text-[10px]">${ph.date}</p>
                                    </div>
                                    <div class="p-2 bg-white">
                                        <p class="text-xs text-gray-600 truncate">${ph.note}</p>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${isEdit ? `
                                <div class="border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center p-6 text-gray-400 hover:border-medical-500 hover:text-medical-500 cursor-pointer transition-colors h-32 lg:h-40" onclick="openModal('doc')">
                                    <i class="fa-solid fa-camera text-2xl mb-2"></i>
                                    <span class="text-sm font-medium">Додати фото</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else if (state.activeTab === 'visits') {
                contentHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden fade-in">
                        <!-- Desktop Table -->
                        <table class="w-full text-sm text-left hidden md:table">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold border-b">
                                <tr>
                                    <th class="p-4">Дата / Час</th>
                                    <th class="p-4">Тип візиту</th>
                                    <th class="p-4">Лікар</th>
                                    <th class="p-4 text-right">Вартість</th>
                                    <th class="p-4 text-center">Статус</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${p.visits.map(v => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="p-4 font-medium text-gray-900">${v.date}</td>
                                        <td class="p-4 text-gray-600">
                                            <div>${v.type}</div>
                                            ${v.note ? `<div class="text-xs text-gray-400 mt-1 italic">"${v.note}"</div>` : ''}
                                        </td>
                                        <td class="p-4 text-gray-600">${v.doctor}</td>
                                        <td class="p-4 text-right font-mono">${v.price} ₴</td>
                                        <td class="p-4 text-center">
                                            ${getStatusBadge(v.status)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <!-- Mobile Cards -->
                        <div class="md:hidden p-4 space-y-3 bg-gray-50">
                             ${p.visits.map(v => `
                                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative">
                                   <div class="flex justify-between items-start mb-2">
                                       <div class="flex flex-col">
                                            <span class="font-bold text-gray-900 text-sm">${v.date}</span>
                                            <span class="text-xs text-gray-500">${v.doctor}</span>
                                       </div>
                                       ${getStatusBadge(v.status)}
                                   </div>
                                   <div class="text-sm text-gray-800 font-medium mb-1">${v.type}</div>
                                   ${v.note ? `<div class="text-xs text-gray-400 mb-3 italic">"${v.note}"</div>` : `<div class="mb-3"></div>`}
                                   <div class="flex justify-between items-center border-t pt-2 border-dashed border-gray-100">
                                       <span class="font-mono font-bold text-gray-700">${v.price} ₴</span>
                                       <button class="text-gray-400 text-xs"><i class="fa-solid fa-chevron-right"></i></button>
                                   </div>
                                </div>
                             `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.activeTab === 'finance') {
                contentHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 lg:gap-6 mb-4 lg:mb-6 fade-in">
                        <div class="bg-white p-3 lg:p-5 rounded-xl border border-gray-200 shadow-sm col-span-2 md:col-span-1">
                            <div class="text-xs text-gray-500 uppercase font-bold">Всього сплачено</div>
                            <div class="text-xl lg:text-2xl font-bold text-green-600 mt-1">${formatCurrency(financeStats.totalPaid)}</div>
                        </div>
                        <div class="bg-white p-3 lg:p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div class="text-xs text-gray-500 uppercase font-bold">Борг</div>
                            <div class="text-xl lg:text-2xl font-bold text-red-500 mt-1">${formatCurrency(financeStats.totalDue)}</div>
                        </div>
                        <div class="bg-white p-3 lg:p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div class="text-xs text-gray-500 uppercase font-bold">Сер. чек</div>
                            <div class="text-xl lg:text-2xl font-bold text-gray-800 mt-1">${formatCurrency(financeStats.avgCheck)}</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="flex justify-between items-center p-4 border-b">
                            <h4 class="font-bold text-gray-700">Історія транзакцій</h4>
                            ${isEdit ? '<button onclick="openModal(\'payment\')" class="text-xs bg-medical-600 text-white px-3 py-1.5 rounded hover:bg-medical-700">+ Платіж</button>' : ''}
                        </div>
                        
                        <!-- Desktop Table -->
                        <table class="w-full text-sm text-left hidden md:table">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">№ Інвойсу</th>
                                    <th class="p-4">Дата</th>
                                    <th class="p-4">Послуга</th>
                                    <th class="p-4">Метод</th>
                                    <th class="p-4 text-right">Сума</th>
                                    <th class="p-4 text-right">Статус</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${p.payments.map(pay => `
                                    <tr>
                                        <td class="p-4 text-gray-400 font-mono text-xs">#${pay.id}</td>
                                        <td class="p-4 text-gray-600">${pay.date}</td>
                                        <td class="p-4 text-gray-900 font-medium">${pay.service}</td>
                                        <td class="p-4 text-gray-500">
                                            ${pay.method === 'card' ? '<i class="fa-regular fa-credit-card"></i> Картка' : 
                                              pay.method === 'cash' ? '<i class="fa-solid fa-money-bill-wave"></i> Готівка' : pay.method}
                                        </td>
                                        <td class="p-4 text-right font-mono">${formatCurrency(pay.amount)}</td>
                                        <td class="p-4 text-right">
                                            ${getPaymentStatusBadge(pay.status)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                         <!-- Mobile Cards -->
                         <div class="md:hidden p-4 space-y-3 bg-gray-50">
                             ${p.payments.map(pay => `
                                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs font-mono text-gray-400">#${pay.id}</span>
                                        <span class="text-xs text-gray-500">${pay.date}</span>
                                    </div>
                                    <div class="font-bold text-gray-900 text-sm">${pay.service}</div>
                                    <div class="flex justify-between items-end mt-1">
                                         <div class="text-xs text-gray-500">
                                            ${pay.method === 'card' ? '<i class="fa-regular fa-credit-card"></i> Картка' : 
                                              pay.method === 'cash' ? '<i class="fa-solid fa-money-bill-wave"></i> Готівка' : pay.method}
                                         </div>
                                         <div class="flex flex-col items-end gap-1">
                                             <span class="font-mono font-bold text-gray-800">${formatCurrency(pay.amount)}</span>
                                             ${getPaymentStatusBadge(pay.status)}
                                         </div>
                                    </div>
                                </div>
                             `).join('')}
                         </div>
                    </div>
                `;
            } else if (state.activeTab === 'drafts') {
                contentHTML = getDraftsLockScreen(false);
            } else if (state.activeTab === 'plan') {
                contentHTML = `
                    <div class="bg-white p-4 lg:p-6 rounded-xl border border-gray-200 shadow-sm fade-in">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="font-bold text-gray-800 text-base lg:text-lg">План лікування: АГА</h3>
                                <p class="text-xs lg:text-sm text-gray-500">Призначено: 15.11.2023</p>
                            </div>
                            <span class="bg-green-100 text-green-700 text-[10px] lg:text-xs font-bold px-3 py-1 rounded-full">Активний</span>
                        </div>
                        
                        <div class="space-y-4 mb-8">
                            ${p.plan.steps.map(step => `
                                <div class="flex items-center p-3 rounded-lg ${step.status === 'done' ? 'bg-gray-50 opacity-75' : 'bg-white border border-gray-100'}">
                                    <div class="mr-4 text-lg">
                                        ${step.status === 'done' ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : 
                                          step.status === 'in-progress' ? '<i class="fa-solid fa-spinner fa-spin text-medical-600"></i>' : 
                                          '<i class="fa-regular fa-circle text-gray-300"></i>'}
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800 text-sm ${step.status === 'done' ? 'line-through text-gray-500' : ''}">${step.text}</p>
                                        ${step.progress ? `<div class="w-full bg-gray-200 rounded-full h-1.5 mt-2"><div class="bg-medical-500 h-1.5 rounded-full" style="width: 40%"></div></div><div class="text-xs text-gray-500 mt-1">${step.progress}</div>` : ''}
                                    </div>
                                    ${isEdit ? '<button class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-ellipsis-vertical"></i></button>' : ''}
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h4 class="font-bold text-blue-800 text-sm mb-2"><i class="fa-solid fa-pills"></i> Призначення (Режим)</h4>
                            <p class="text-sm text-blue-900">${p.plan.meds}</p>
                        </div>
                    </div>
                `;
            } else {
                // Docs Tab
                contentHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 fade-in">
                        ${p.docs.map(doc => `
                            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-start hover:shadow-md transition-shadow">
                                <div class="bg-gray-100 p-3 rounded-lg mr-3 text-gray-500 text-xl">
                                    ${doc.type === 'pdf' ? '<i class="fa-solid fa-file-pdf text-red-500"></i>' : 
                                      doc.type === 'img' ? '<i class="fa-solid fa-file-image text-purple-500"></i>' : '<i class="fa-solid fa-file-word text-blue-500"></i>'}
                                </div>
                                <div class="flex-1 overflow-hidden">
                                    <h5 class="font-bold text-gray-800 text-sm truncate" title="${doc.name}">${doc.name}</h5>
                                    <p class="text-xs text-gray-500 mt-1">${doc.date} • ${doc.size}</p>
                                </div>
                                <button class="text-gray-400 hover:text-medical-600"><i class="fa-solid fa-download"></i></button>
                            </div>
                        `).join('')}
                        ${isEdit ? `
                            <div class="border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 hover:border-medical-500 hover:text-medical-500 p-4 cursor-pointer transition-colors" onclick="openModal('doc')">
                                <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2"></i>
                                <span class="text-sm font-medium">Завантажити файл</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // MAIN PATIENT WRAPPER
            return `
                <div class="max-w-7xl mx-auto space-y-4 lg:space-y-6">
                    <!-- Profile Header -->
                    <div class="bg-white rounded-2xl p-4 lg:p-6 shadow-sm border border-gray-200 flex flex-col md:flex-row items-center md:items-start gap-4 lg:gap-6">
                        <div class="relative">
                            <img src="${p.info.avatar}" alt="Avatar" class="w-20 h-20 lg:w-24 lg:h-24 rounded-full border-4 border-gray-50">
                            ${isEdit ? '<button class="absolute bottom-0 right-0 bg-white border shadow p-1.5 rounded-full text-xs text-gray-600 hover:text-medical-600"><i class="fa-solid fa-camera"></i></button>' : ''}
                        </div>
                        <div class="flex-1 text-center md:text-left w-full">
                            <div class="flex flex-col md:flex-row md:flex-wrap items-center gap-2 lg:gap-3 mb-2 justify-center md:justify-start">
                                ${isEdit ? 
                                    `<input type="text" value="${p.info.lastName} ${p.info.firstName}" class="text-xl font-bold text-gray-900 bg-gray-50 border rounded px-2 py-1 text-center md:text-left">` :
                                    `<h2 class="text-xl lg:text-2xl font-bold text-gray-900">${p.info.lastName} ${p.info.firstName}</h2>`
                                }
                                <div class="flex gap-2 justify-center">
                                    ${p.info.tags.map(t => `<span class="px-2 py-1 bg-medical-50 text-medical-700 text-[10px] lg:text-xs font-bold rounded-full border border-medical-100">${t}</span>`).join('')}
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 lg:gap-4 text-xs lg:text-sm text-gray-600 mt-2 lg:mt-4">
                                <div><i class="fa-solid fa-phone w-4 text-center text-gray-400"></i> ${p.info.phone}</div>
                                <div><i class="fa-solid fa-cake-candles w-4 text-center text-gray-400"></i> ${getAge(p.info.dob)} років</div>
                                <div><i class="fa-solid fa-location-dot w-4 text-center text-gray-400"></i> ${p.info.city}</div>
                                <div class="${financeStats.totalDue > 0 ? 'text-red-500 font-bold' : 'text-green-600'}"><i class="fa-solid fa-wallet w-4 text-center text-gray-400"></i> ${financeStats.totalDue > 0 ? `Борг: ${financeStats.totalDue}` : '0 ₴'}</div>
                            </div>
                        </div>
                         <!-- Desktop Quick Action -->
                        <div class="hidden md:flex flex-col gap-2 w-full md:w-auto">
                            <button onclick="openModal('appointment')" class="bg-medical-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-medical-700 shadow-sm transition-transform active:scale-95">
                                + Записати
                            </button>
                        </div>
                    </div>

                    <!-- Tabs & Content -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 min-h-[500px]">
                        <div class="flex overflow-x-auto border-b border-gray-200 px-4 lg:px-6 pt-2 lg:pt-4 gap-4 lg:gap-6 hide-scrollbar sticky top-0 bg-white z-20 rounded-t-2xl">
                            ${tabsHTML}
                        </div>
                        <div class="p-4 lg:p-6">
                            ${contentHTML}
                        </div>
                    </div>
                </div>

                <!-- Footer Disclaimer -->
                <div class="text-center py-6 text-gray-400 text-xs pb-20 lg:pb-6">
                    <p>Демо-версія. Дані вигадані. Не є медичною інформаційною системою.</p>
                </div>
            `;
        }

        // --- HELPERS ---
        function getAge(dateString) {
            const today = new Date();
            const birthDate = new Date(dateString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function getStatusBadge(status) {
            const styles = {
                'completed': 'bg-green-100 text-green-700 border-green-200',
                'scheduled': 'bg-blue-100 text-blue-700 border-blue-200',
                'no-show': 'bg-red-100 text-red-700 border-red-200',
                'cancelled': 'bg-gray-100 text-gray-600 border-gray-200'
            };
            const labels = {
                'completed': 'Завершено',
                'scheduled': 'Заплановано',
                'no-show': 'Неявка',
                'cancelled': 'Скасовано'
            };
            return `<span class="px-2 py-1 rounded text-[10px] lg:text-xs font-bold border ${styles[status] || styles['scheduled']}">${labels[status]}</span>`;
        }

        function getPaymentStatusBadge(status) {
             const styles = {
                'paid': 'text-green-600 bg-green-50',
                'unpaid': 'text-red-600 bg-red-50',
                'partially-paid': 'text-orange-600 bg-orange-50'
            };
            const labels = {
                'paid': 'Сплачено',
                'unpaid': 'Не сплачено',
                'partially-paid': 'Частково'
            };
            return `<span class="px-2 py-1 rounded text-[10px] lg:text-xs font-bold ${styles[status]}">${labels[status]}</span>`;
        }

        // --- INTERACTION LOGIC ---

        function navigateTo(view) {
            state.currentView = view;
            renderApp();
            
            // Mobile: close sidebar on nav
            const sidebar = el('sidebar');
            const overlay = el('mobile-overlay');
            if (window.innerWidth < 1024) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
            
            // Update mobile nav styling if needed (simple active state for demo)
            // Ideally we'd add IDs to mobile nav buttons and toggle classes similar to sidebar
        }

        function setActiveTab(tabId) {
            state.activeTab = tabId;
            if (tabId !== 'drafts') lockDrafts(); 
            renderApp();
        }

        function toggleSidebar() {
            const sidebar = el('sidebar');
            const overlay = el('mobile-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function toggleMobileSearch() {
            const searchBar = el('mobile-search-bar');
            searchBar.classList.toggle('hidden');
            if(!searchBar.classList.contains('hidden')) {
                searchBar.querySelector('input').focus();
            }
        }
        
        function toggleMobileMode() {
            const newMode = state.mode === 'view' ? 'edit' : 'view';
            setMode(newMode);
            // Update icon
            const icon = el('mobile-mode-icon');
            if(newMode === 'edit') {
                icon.className = 'fa-solid fa-eye text-lg text-medical-600';
            } else {
                icon.className = 'fa-solid fa-pen-to-square text-lg';
            }
        }

        function setMode(mode) {
            state.mode = mode;
            updateModeUI();
            renderApp();
            showToast(mode === 'edit' ? 'Режим редагування' : 'Режим перегляду', 'info');
        }

        function updateModeUI() {
            const btnView = el('btn-mode-view');
            const btnEdit = el('btn-mode-edit');
            
            if (state.mode === 'view') {
                btnView.className = "px-3 py-1.5 rounded-md text-xs font-semibold shadow-sm bg-white text-gray-800 transition-all";
                btnEdit.className = "px-3 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-900 transition-all";
            } else {
                btnView.className = "px-3 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-900 transition-all";
                btnEdit.className = "px-3 py-1.5 rounded-md text-xs font-semibold shadow-sm bg-medical-600 text-white transition-all";
            }
        }

        // --- SEARCH LOGIC ---
        function toggleSearchHelp(show) {
            const dropdown = el('search-help');
            if(show) {
                dropdown.classList.remove('hidden');
                setTimeout(() => {
                    dropdown.classList.remove('opacity-0', 'scale-y-95');
                    dropdown.classList.add('visible');
                }, 10);
            } else {
                dropdown.classList.remove('visible');
                dropdown.classList.add('opacity-0', 'scale-y-95');
                setTimeout(() => {
                    dropdown.classList.add('hidden');
                }, 200);
            }
        }

        // --- PIN LOGIC ---
        function unlockDrafts() {
            const input = el('pin-input');
            if (input.value === state.pin) {
                state.pinLocked = false;
                renderApp();
                // Auto lock timer
                if (state.inactivityTimer) clearTimeout(state.inactivityTimer);
                state.inactivityTimer = setTimeout(() => lockDrafts(), 60000); // 60s
            } else {
                input.classList.add('border-red-500', 'animate-pulse');
                setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 500);
                showToast('Невірний PIN код', 'error');
            }
        }

        function lockDrafts() {
            state.pinLocked = true;
            if (state.activeTab === 'drafts' || state.currentView === 'drafts_global') renderApp();
        }

        // --- MODALS ---
        function openModal(type) {
            const backdrop = el('modal-backdrop');
            const content = el('modal-content');
            backdrop.classList.remove('hidden');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('scale-95');
            }, 10);

            let modalHTML = '';
            
            if (type === 'appointment') {
                modalHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-4">Новий запис</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Пацієнт</label>
                                <input type="text" value="Коваленко Олена" disabled class="mt-1 w-full bg-gray-100 border border-gray-300 rounded-md p-2 text-gray-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Дата</label>
                                    <input type="date" class="mt-1 w-full border border-gray-300 rounded-md p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Час</label>
                                    <input type="time" class="mt-1 w-full border border-gray-300 rounded-md p-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Послуга</label>
                                <select class="mt-1 w-full border border-gray-300 rounded-md p-2">
                                    <option>Консультація</option>
                                    <option>Мезотерапія</option>
                                    <option>Плазмотерапія</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Скасувати</button>
                            <button onclick="mockSave('Запис створено')" class="px-4 py-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700">Зберегти</button>
                        </div>
                    </div>
                `;
            } else if (type === 'payment') {
                modalHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-4">Новий платіж</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Сума (UAH)</label>
                                <input type="number" placeholder="0.00" class="mt-1 w-full border border-gray-300 rounded-md p-2 text-lg font-bold">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Метод</label>
                                <select class="mt-1 w-full border border-gray-300 rounded-md p-2">
                                    <option>Готівка</option>
                                    <option>Термінал (Картка)</option>
                                    <option>IBAN</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Скасувати</button>
                            <button onclick="mockSave('Платіж проведено')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Оплатити</button>
                        </div>
                    </div>
                `;
            } else if (type === 'doc') {
                 modalHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-4">Завантаження файлу</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 mb-4">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-500">Натисніть або перетягніть файл сюди</p>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Скасувати</button>
                            <button onclick="mockSave('Файл завантажено')" class="px-4 py-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700">Зберегти</button>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = modalHTML;
        }

        function closeModal() {
            const backdrop = el('modal-backdrop');
            const content = el('modal-content');
            backdrop.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => {
                backdrop.classList.add('hidden');
            }, 200);
        }

        function mockSave(msg) {
            closeModal();
            // Simulate network delay
            setTimeout(() => {
                showToast(msg, 'success');
            }, 500);
        }

        // --- TOASTS ---
        function showToast(message, type = 'success') {
            const container = el('toast-container');
            const toast = document.createElement('div');
            
            const colors = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-500' : 'bg-gray-800';
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

            toast.className = `${colors} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-300`;
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="text-sm font-medium">${message}</span>`;
            
            container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- CHARTS ---
        let revenueChart = null;

        function initChart() {
            const ctx = el('revenueChart');
            if(!ctx) return;
            
            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Тиж 1', 'Тиж 2', 'Тиж 3', 'Тиж 4', 'Тиж 5', 'Тиж 6', 'Тиж 7', 'Поточний'],
                    datasets: [{
                        label: 'Дохід (UAH)',
                        data: [12000, 15000, 11000, 18000, 22000, 19500, 24000, 32400],
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            renderApp();
        });

    </script>
</body>
</html>
